---
title: 'Jonah Crab CCM significance testing'
date-modified: '2023-07-28'
execute: 
  message: false
  warning: false
editor_options: 
  chunk_output_type: console
editor: 
  markdown: 
    wrap: 72
---

# Re-run CCM with max lib size

## Aggregate

### Catch
### Weight

## Regions

### Catch
```{r}
# By region, each individually - CATCH max lib size
RESULTS_ccm_by_reg_max <- pmap_dfr(params_regions_combos,function(jonah,prey, region){
  df_temp <- catchCCMdf_reg %>% filter(Region == region)
  lib_vec <- paste(1, nrow(df_temp))
  #jonah -> prey
  rho_E_1<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = jonah,target = prey, maxE = 7, showPlot = FALSE)
  E_out_1<-rho_E_1[which.max(rho_E_1$rho),"E"][1]
  out_1 <- CCM(dataFrame= df_temp, columns=jonah, target=prey, E = E_out_1, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_1, nrow(df_temp) - E_out_1, "1",sep=" "), sample=100, verbose=FALSE, showPlot = FALSE) %>%
    mutate(jonah=jonah,prey=prey, direction= paste("jonah","->","prey"),region=region,E = E_out_1)
  rho_E_2<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = prey,target = jonah, maxE = 7, showPlot = FALSE)
  E_out_2<-rho_E_2[which.max(rho_E_1$rho),"E"][1]
  out_2 <- CCM(dataFrame= df_temp, columns=prey, target=jonah, E = E_out_2, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_2, nrow(df_temp)-E_out_2, "1",sep=" "), sample=100, verbose=FALSE, showPlot = FALSE)  %>%
   mutate(jonah=jonah,prey=prey,direction= paste("prey","->","jonah"),region=region,E = E_out_2)
  bind_rows(out_1,out_2)
}) %>% addDirection()

RESULTS_ccm_by_reg_max<- RESULTS_ccm_by_reg_max %>% group_by(xmap) %>% pivot_longer(cols=all_of(combos)) %>% na.omit() %>% filter(substr(xmap, 1, 1)==substr(name, 1, 1))

```

### Weight
```{r}
# By region, each individually - WEIGHT max lib size
RESULTS_ccm_wt_by_reg_max <- pmap_dfr(params_regions_combos,function(jonah,prey, region){
  df_temp <- wtCCMdf_reg %>% filter(Region == region)
  lib_vec <- paste(1, nrow(df_temp))
  rho_E_1<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = jonah,target = prey, maxE = 7, showPlot = FALSE)
  E_out_1<-rho_E_1[which.max(rho_E_1$rho),"E"][1]
  out_1 <- CCM(dataFrame= df_temp, columns=jonah, target=prey, E = E_out_1, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_1, nrow(df_temp) - E_out_1, "1",sep=" "), sample=100, verbose=FALSE, showPlot = FALSE) %>%
    mutate(jonah=jonah,prey=prey, direction= paste("jonah","->","prey"),region=region,E = E_out_1)
  rho_E_2<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = prey,target = jonah, maxE = 7, showPlot = FALSE)
  E_out_2<-rho_E_2[which.max(rho_E_1$rho),"E"][1]
  out_2 <- CCM(dataFrame= df_temp, columns=prey, target=jonah, E = E_out_2, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_2, nrow(df_temp)-E_out_2, "1",sep=" "), sample=100, verbose=FALSE, showPlot = FALSE)  %>%
    mutate(jonah=jonah,prey=prey,direction= paste("prey","->","jonah"),region=region,E = E_out_2)
  bind_rows(out_1,out_2)
}) %>% addDirection()

RESULTS_ccm_wt_by_reg_max<- RESULTS_ccm_wt_by_reg_max %>% group_by(xmap) %>% pivot_longer(cols=all_of(combos)) %>% na.omit() %>% filter(substr(xmap, 1, 1)==substr(name, 1, 1))

```

## Strata

### Catch

### Weight

## Areas

### Catch

### Weight

The second criteria for significant convergence is statistically significant cross-map skill at maximum library size. Although we got p-values for max lib size above using the compute_stats function, the validity of these p-values is questionable. The standard method of determining significance is with randomization tests, where you randomly rearrange the predictor time series to destroy the dynamic relationship between variables and perform CCM between the shuffled time series and the original target time series. This randomization is repeated 100 (or 1000) times to generate a null distribution of cross-map skill, against which the actual value can be compared.

We will use the "surrogate" function from the package tseries.

We'll start with the aggregate catch CCM as an example:
# Surrogate data
## Aggregate
```{r}
#Create 100 random surrogates of the jonah column and bind to the date, scallop, and rock columns of the data frame we used for aggregate CCM
set.seed(7)
ccm_agg_surr <- cbind(catchCCMdf_agg, surrogate(catchCCMdf_agg$jonah, ns=100)) %>% select(-jonah)

#Rename the surrogate columns to be of the form "jonah_1", "jonah_2", etc.
ccm_agg_surr <- rename_with(ccm_agg_surr,.cols=!any_of(c("date", "scallop", "rock")),~ paste0("jonah_", .x, recycle0 = TRUE))

#Create the data frame that will store the combinations we want to test
params_ccm_combos_surr <- map_dfr(seq_len(100), ~params_ccm_combos %>% select(-"jonah"))
params_ccm_combos_surr <- params_ccm_combos_surr %>% mutate(surr_trial = rep(1:100, each=2))
```

```{r}

RESULTS_ccm_agg_surr <- pmap_dfr(params_ccm_combos_surr,function(prey, surr_trial){
  
  lib_vec <- paste(1, nrow(ccm_agg_surr))
  jonah_col = paste("jonah",surr_trial, sep="_" )
  
  #The only difference for finding E opt is that the column name for jonah is now jonah_n, 
  #where n is the surrogate trial number
  rho_E_1<- EmbedDimension(dataFrame = ccm_agg_surr, lib = lib_vec, pred = lib_vec, 
                           columns = jonah_col,target = prey, maxE = 7, showPlot = FALSE) 
  E_out_1<-rho_E_1[which.max(rho_E_1$rho),"E"][1] #store E
  
  #Run CCM - jonah to rock/scallop
  #We are only running the CCM at max lib size
  out_1 <- CCM(dataFrame= ccm_agg_surr, columns=jonah_col, target=prey, E = E_out_1, Tp=1,
               libSizes = paste(nrow(ccm_agg_surr) - E_out_1, nrow(ccm_agg_surr) - E_out_1, 
                                "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE) %>%
    mutate(prey=prey,
           direction= paste("jonah","->","prey"),
           E = E_out_1, trial_num = surr_trial) %>% 
  rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
  rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  
  #find optimal E for predicting jonah from scallop or rock (i.e., scallop/rock -> jonah)
  rho_E_2<- EmbedDimension(dataFrame = ccm_agg_surr, lib = lib_vec, pred = lib_vec, 
                           columns = prey,target = jonah_col, maxE = 7, showPlot = FALSE)
  E_out_2<-rho_E_2[which.max(rho_E_1$rho),"E"][1] #store E
  
  #Run CCM - rock/scallop to jonah
  out_2 <- CCM(dataFrame= ccm_agg_surr, columns=prey, target=jonah_col, E = E_out_2, Tp=1, 
               libSizes = paste(nrow(ccm_agg_surr)-E_out_2, nrow(ccm_agg_surr)-E_out_2, "1",sep=" "), 
               sample=1, verbose=FALSE, showPlot = FALSE) %>%
    mutate(prey=prey,
           direction= paste("prey","->","jonah"),
           E = E_out_2, trial_num = surr_trial)  %>% 
  rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
  rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  
  bind_rows(out_1,out_2)
  
}) %>% mutate("jonah"=NA) %>% addDirection()
```

```{r}
# Rho at max lib size - original
RESULTS_ccm_aggregate %>% group_by(xmap) %>% summarize(across(all_of(combos),last)) %>% pivot_longer(cols=all_of(combos)) %>% na.omit() %>% filter(substr(xmap, 1, 1)==substr(name, 1, 1))
```
rock:jonah is clearly not significant, but we will want null distributions for the other three.

```{r}
# Rho at max lib size - surr
RESULTS_ccm_agg_surr %>% group_by(xmap) %>% pivot_longer(cols=all_of(combos)) %>% na.omit() %>% filter(substr(xmap, 1, 1)==substr(name, 1, 1))

js_c_null <- RESULTS_ccm_agg_surr %>% 
  group_by(xmap) %>% 
  pivot_longer(cols=all_of(combos)) %>% 
  na.omit() %>% 
  filter(substr(xmap, 1, 1)==substr(name, 1, 1)) %>% 
  filter(name=="jonah:scallop")
```

Did we get a null distribution? Yes!
```{r}
hist(js_c_null$value)
quantile(js_c_null$value, 0.95)
1-ecdf(js_c_null$value)(0.225)

ggplot(js_c_null, aes(value)) +
stat_ecdf(geom = "step")+
  geom_hline(yintercept = 0.95)+
  geom_vline(xintercept = 0.42068)+
  geom_vline(xintercept = 0.225, color="red")
```

Unfortunately, we can see that our empirical cross-map skill of 0.225 does not exceed the p-value threshold of 0.05; 28% of the surrogate trials produced a cross-map skill equal to or higher than 0.225.
Let's write a function to quickly check the others:

```{r}
null_dist <- function(df, s) {
  df_out <- df %>% group_by(xmap) %>% 
  pivot_longer(cols=all_of(combos)) %>% 
  na.omit() %>% 
  filter(substr(xmap, 1, 1)==substr(name, 1, 1)) %>% 
  filter(name==s)
  return(df_out %>% pull(value))
}

null_dist(RESULTS_ccm_agg_surr, s="jonah:scallop")
1-ecdf(null_dist(RESULTS_ccm_agg_surr, s="jonah:scallop"))(0.225) #p=0.28
1-ecdf(null_dist(RESULTS_ccm_agg_surr, s="scallop:jonah"))(0.219) #p=0.09
1-ecdf(null_dist(RESULTS_ccm_agg_surr, s="jonah:rock"))(0.207) #p=0.35
```

The only agg weight cross-map skill >0 was jonah:rock, and permutation testing gave that a p-val of 0.23.

On to regions. We're going to define a quick help function to find the max cross-map skill from the actual time series.

## By region
```{r}
# find_max <- function(df) {
#   df_out <- df %>% summarise(
#     max_J_S = max(`jonah:scallop`, na.rm = TRUE),
#     max_S_J = max(`scallop:jonah`, na.rm = TRUE),
#     max_J_R = max(`jonah:rock`, na.rm = TRUE),
#     max_R_J = max(`rock:jonah`, na.rm = TRUE))
#   return(df_out)
# }
```

```{r}
# max_rho_by_area<- RESULTS_ccm_by_area %>% group_by(area) %>% find_max()
# max_rho_wt_by_area<- RESULTS_ccm_wt_by_area %>% group_by(area) %>% find_max()
# 
# colSums(max_rho_by_area >0)
# colSums(max_rho_wt_by_area>0)
```

We can see that for catchm max rho for J-\>S was \>0 for all area and
max rho for J-\>R was \>0 for 18/20 areas. For weight, max rho for J-\>S
was \>0 for 18/20 areas and max rho for J-\>R was \>0 for 19/20 areas.
S-\>J was 6 and 7 and R-\>J was 10 and 8 for catch and weight,
respectively.

```{r}
# max_rho_by_reg<- RESULTS_ccm_by_reg %>% group_by(region) %>% find_max()
# max_rho_wt_by_reg<- RESULTS_ccm_wt_by_reg %>% group_by(region) %>% find_max()
# 
# max_rho_by_strat<- RESULTS_ccm_by_strat %>% group_by(stratum) %>% find_max()
# max_rho_wt_by_strat<- RESULTS_ccm_wt_by_strat %>% group_by(stratum) %>% find_max()
```

### Catch
Create surrogate data
```{r}
set.seed(7)
ccm_reg_surr <- catchCCMdf_reg %>% group_by(Region) %>% mutate(new=surrogate(jonah, ns=100)) %>% select(-jonah) %>% mutate(new=data.frame(new)) %>% unnest(cols=new)

#Rename the surrogate columns to be of the form "jonah_1", "jonah_2", etc.
ccm_reg_surr <- rename_with(ccm_reg_surr,.cols=!any_of(c("date", "scallop", "rock", "Region")),~ paste0("jonah_", .x, recycle0 = TRUE) %>% str_remove("X"))

#Create the data frame that will store the combinations we want to test
params_regions_combos_surr <- map_dfr(seq_len(100), ~params_regions_combos %>% select(-"jonah"))
params_regions_combos_surr <- params_regions_combos_surr %>% mutate(surr_trial = rep(1:100, each=10))
```

```{r}
# Random CCM by region, each individually - CATCH

RESULTS_ccm_by_reg_surr <- pmap_dfr(params_regions_combos_surr,function(prey, region, surr_trial){
  df_temp <- ccm_reg_surr %>% filter(Region == region)
  lib_vec <- paste(1, nrow(df_temp))
  jonah_col = paste("jonah",surr_trial, sep="_" )
  
  rho_E_1<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = jonah_col,target = prey, maxE = 7, showPlot = FALSE)
  E_out_1<-rho_E_1[which.max(rho_E_1$rho),"E"][1]
  out_1 <- CCM(dataFrame= df_temp, columns=jonah_col, target=prey, E = E_out_1, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_1, nrow(df_temp) - E_out_1, 
                                "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE) %>%
    mutate(prey=prey,
           direction= paste("jonah","->","prey"),
           E = E_out_1,region=region, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  
  rho_E_2<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = prey,target = jonah_col, maxE = 7, showPlot = FALSE)
  E_out_2<-rho_E_2[which.max(rho_E_1$rho),"E"][1]
  out_2 <- CCM(dataFrame= df_temp, columns=prey, target=jonah_col, E = E_out_2, Tp=1,
               libSizes = paste(nrow(df_temp)-E_out_2, nrow(df_temp)-E_out_2, "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE)  %>%
    mutate(prey=prey,
           direction= paste("prey","->","jonah"),
           E = E_out_2,region=region, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  

  bind_rows(out_1,out_2)
}) %>% mutate("jonah"=NA)  %>% addDirection()
```


```{r}
# Rho at max lib size - surr regions
RESULTS_ccm_by_reg_surr %>% 
  group_by(xmap, region) %>% 
  pivot_longer(cols=all_of(combos)) %>% 
  na.omit() %>% 
  filter(substr(xmap, 1, 1)==substr(name, 1, 1))

```

If we look back at the max rho by region, we can see that we only really need to test jonah:scallop (all regions), jonah:rock (all regions), and rock:jonah for region 1 only.

```{r}

1-ecdf(null_dist(df = RESULTS_ccm_by_reg_surr %>% filter(region==1), s="rock:jonah"))(0.141) #p=0.08

map(1:5, function(x) {
  ndist = null_dist(df = RESULTS_ccm_by_reg_surr %>% filter(region==x), s="jonah:scallop")
  prob = 1-ecdf(ndist)(max_rho_by_reg[x,"max_J_S"])
  return(prob)
})

map(1:5, function(x) {
  ndist = null_dist(df = RESULTS_ccm_by_reg_surr %>% filter(region==x), s="jonah:rock")
  prob = 1-ecdf(ndist)(max_rho_by_reg[x,"max_J_R"])
  return(prob)
})

map(1:5, function(x) {
  ndist = null_dist(df = RESULTS_ccm_by_reg_surr %>% filter(region==x), s="scallop:jonah")
  prob = 1-ecdf(ndist)(max_rho_by_reg[x,"max_S_J"])
  return(prob)
})

map(1:5, function(x) {
  ndist = null_dist(df = RESULTS_ccm_by_reg_surr %>% filter(region==x), s="rock:jonah")
  prob = 1-ecdf(ndist)(max_rho_by_reg[x,"max_R_J"])
  return(prob)
})

#check the map works correctly, it does
# 1-ecdf(null_dist(df = RESULTS_ccm_by_reg_surr %>% filter(region==2),  s="jonah:scallop"))(.201)

#jonah:rock is borderline significant (p=0.07) in Region 2, p=0.1 in Region 4

```

### Weight
```{r}
#Create surrogate data
set.seed(7)
ccm_reg_wt_surr <- wtCCMdf_reg %>% group_by(Region) %>% mutate(new=surrogate(jonah, ns=100)) %>% select(-jonah) %>% mutate(new=data.frame(new)) %>% unnest(cols=new)

#Rename the surrogate columns to be of the form "jonah_1", "jonah_2", etc.
ccm_reg_wt_surr <- rename_with(ccm_reg_wt_surr,.cols=!any_of(c("date", "scallop", "rock", "Region")),~ paste0("jonah_", .x, recycle0 = TRUE) %>% str_remove("X"))

# Random CCM by region, each individually - weight

RESULTS_ccm_wt_by_reg_surr <- pmap_dfr(params_regions_combos_surr,function(prey, region, surr_trial){
  df_temp <- ccm_reg_wt_surr %>% filter(Region == region)
  lib_vec <- paste(1, nrow(df_temp))
  jonah_col = paste("jonah",surr_trial, sep="_" )
  
  rho_E_1<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = jonah_col,target = prey, maxE = 7, showPlot = FALSE)
  E_out_1<-rho_E_1[which.max(rho_E_1$rho),"E"][1]
  out_1 <- CCM(dataFrame= df_temp, columns=jonah_col, target=prey, E = E_out_1, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_1, nrow(df_temp) - E_out_1, 
                                "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE) %>%
    mutate(prey=prey,
           direction= paste("jonah","->","prey"),
           E = E_out_1,region=region, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  
  rho_E_2<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = prey,target = jonah_col, maxE = 7, showPlot = FALSE)
  E_out_2<-rho_E_2[which.max(rho_E_1$rho),"E"][1]
  out_2 <- CCM(dataFrame= df_temp, columns=prey, target=jonah_col, E = E_out_2, Tp=1,
               libSizes = paste(nrow(df_temp)-E_out_2, nrow(df_temp)-E_out_2, "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE)  %>%
    mutate(prey=prey,
           direction= paste("prey","->","jonah"),
           E = E_out_2,region=region, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  bind_rows(out_1,out_2)
}) %>% mutate("jonah"=NA)  %>% addDirection()


quantile(null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==2), s="scallop:jonah"), .95)

1-ecdf(null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==1), s="scallop:jonah"))(0.219) #p=0

ggplot(data.frame(x=null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==1), s="scallop:jonah")), aes(x)) +
  stat_ecdf(geom = "step")+
  geom_hline(yintercept = 0.95)+
  geom_vline(xintercept = 0.219, color="red")

ggplot(data.frame(x=null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==2), s="scallop:jonah")), aes(x)) +
  stat_ecdf(geom = "step")+
  geom_hline(yintercept = 0.95)+
  geom_vline(xintercept = 0.1612493)+
  geom_vline(xintercept = 0.312, color="red")+theme_bw()

ggplot(data.frame(x=null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==2), s="scallop:jonah")), aes(x)) +
  geom_histogram(bins = 25)+
  geom_hline(yintercept = 0.95)+
  geom_vline(xintercept = 0.1612493)+
  geom_vline(xintercept = 0.312, color="red")+theme_bw()

map(1:5, function(x) {
  ndist = null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==x), s="jonah:scallop")
  prob = 1-ecdf(ndist)(max_rho_wt_by_reg[x,"max_J_S"])
  return(prob)
})

map(1:5, function(x) {
  ndist = null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==x), s="jonah:rock")
  prob = 1-ecdf(ndist)(max_rho_wt_by_reg[x,"max_J_R"])
  return(prob)
})

map(1:5, function(x) {
  ndist = null_dist(df = RESULTS_ccm_wt_by_reg_surr %>% filter(region==x), s="scallop:jonah")
  prob = 1-ecdf(ndist)(max_rho_wt_by_reg[x,"max_S_J"])
  return(prob)
})
```

scallop:jonah for weight is statistically significant in regions 1 and 2!

Now let's look at strata.
## By stratum

### Catch
```{r}
#Create the data frame that will store the combinations we want to test
params_strat_combos_surr <- map_dfr(seq_len(100), ~params_strat_combos %>% select(-"jonah"))
params_strat_combos_surr <- params_strat_combos_surr %>% mutate(surr_trial = rep(1:100, each=8))

#Create surrogate data
set.seed(7)
ccm_strat_surr <- catchCCMdf_strat %>% group_by(Stratum) %>% mutate(new=surrogate(jonah, ns=100)) %>% select(-jonah) %>% mutate(new=data.frame(new)) %>% unnest(cols=new)

ccm_strat_surr <- rename_with(ccm_strat_surr,.cols=!any_of(c("date", "scallop", "rock", "Stratum")),~ paste0("jonah_", .x, recycle0 = TRUE) %>% str_remove("X"))

# Random CCM by region, each individually - weight

RESULTS_ccm_by_strat_surr <- pmap_dfr(params_strat_combos_surr,function(prey, stratum, surr_trial){
  df_temp <- ccm_strat_surr %>% filter(Stratum==stratum)
  lib_vec <- paste(1, nrow(df_temp))
  jonah_col = paste("jonah",surr_trial, sep="_" )
  
  rho_E_1<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = jonah_col,target = prey, maxE = 7, showPlot = FALSE)
  E_out_1<-rho_E_1[which.max(rho_E_1$rho),"E"][1]
  out_1 <- CCM(dataFrame= df_temp, columns=jonah_col, target=prey, E = E_out_1, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_1, nrow(df_temp) - E_out_1, 
                                "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE) %>%
    mutate(prey=prey,
           direction= paste("jonah","->","prey"),
           E = E_out_1,stratum=stratum, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  
  rho_E_2<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = prey,target = jonah_col, maxE = 7, showPlot = FALSE)
  E_out_2<-rho_E_2[which.max(rho_E_1$rho),"E"][1]
  out_2 <- CCM(dataFrame= df_temp, columns=prey, target=jonah_col, E = E_out_2, Tp=1,
               libSizes = paste(nrow(df_temp)-E_out_2, nrow(df_temp)-E_out_2, "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE)  %>%
    mutate(prey=prey,
           direction= paste("prey","->","jonah"),
           E = E_out_2,stratum=stratum, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  bind_rows(out_1,out_2)
}) %>% mutate("jonah"=NA)  %>% addDirection()

```

```{r}

map(1:4, function(x) {
  ndist = null_dist(df = RESULTS_ccm_by_strat_surr %>% filter(stratum==x), s="jonah:rock")
  prob = 1-ecdf(ndist)(max_rho_by_strat[x,"max_J_R"])
  return(prob)
}) #strat 4 is sig, p=0.03

map(1:4, function(x) {
  ndist = null_dist(df = RESULTS_ccm_by_strat_surr %>% filter(stratum==x), s="scallop:jonah")
  prob = 1-ecdf(ndist)(max_rho_by_strat[x,"max_S_J"])
  return(prob)
}) #strats 3 and 4 are sig, p=0 and p=0.01

map(1:4, function(x) {
  ndist = null_dist(df = RESULTS_ccm_by_strat_surr %>% filter(stratum==x), s="rock:jonah")
  prob = 1-ecdf(ndist)(max_rho_by_strat[x,"max_R_J"])
  return(prob)
}) #strat 1 is sig, p=0.02

#none sig for jonah:scallop
```

### Weight
```{r}
#Create surrogate data
set.seed(7)
ccm_strat_wt_surr <- wtCCMdf_strat %>% group_by(Stratum) %>% mutate(new=surrogate(jonah, ns=100)) %>% select(-jonah) %>% mutate(new=data.frame(new)) %>% unnest(cols=new)

ccm_strat_wt_surr <- rename_with(ccm_strat_wt_surr,.cols=!any_of(c("date", "scallop", "rock", "Stratum")),~ paste0("jonah_", .x, recycle0 = TRUE) %>% str_remove("X"))

# Random CCM by region, each individually - weight

RESULTS_ccm_wt_by_strat_surr <- pmap_dfr(params_strat_combos_surr,function(prey, stratum, surr_trial){
  df_temp <- ccm_strat_wt_surr %>% filter(Stratum==stratum)
  lib_vec <- paste(1, nrow(df_temp))
  jonah_col = paste("jonah",surr_trial, sep="_" )
  
  rho_E_1<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = jonah_col,target = prey, maxE = 7, showPlot = FALSE)
  E_out_1<-rho_E_1[which.max(rho_E_1$rho),"E"][1]
  out_1 <- CCM(dataFrame= df_temp, columns=jonah_col, target=prey, E = E_out_1, Tp=1,
               libSizes = paste(nrow(df_temp) - E_out_1, nrow(df_temp) - E_out_1, 
                                "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE) %>%
    mutate(prey=prey,
           direction= paste("jonah","->","prey"),
           E = E_out_1,stratum=stratum, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  
  rho_E_2<- EmbedDimension(dataFrame = df_temp, lib = lib_vec, pred = lib_vec,
                           columns = prey,target = jonah_col, maxE = 7, showPlot = FALSE)
  E_out_2<-rho_E_2[which.max(rho_E_1$rho),"E"][1]
  out_2 <- CCM(dataFrame= df_temp, columns=prey, target=jonah_col, E = E_out_2, Tp=1,
               libSizes = paste(nrow(df_temp)-E_out_2, nrow(df_temp)-E_out_2, "1",sep=" "), sample=1, verbose=FALSE, showPlot = FALSE)  %>%
    mutate(prey=prey,
           direction= paste("prey","->","jonah"),
           E = E_out_2,stratum=stratum, trial_num = surr_trial) %>% 
    rename_with( ~ paste0("jonah:", prey, recycle0 = TRUE), starts_with("jonah")) %>% 
    rename_with( ~ paste0(prey, ":jonah",recycle0 = TRUE), starts_with(prey))
  bind_rows(out_1,out_2)
}) %>% mutate("jonah"=NA)  %>% addDirection()

```

```{r}

map(1:4, function(x) {
  ndist = null_dist(df = RESULTS_ccm_wt_by_strat_surr %>% filter(stratum==x), s="jonah:rock")
  prob = 1-ecdf(ndist)(max_rho_wt_by_strat[x,"max_J_R"])
  return(prob)
}) #strat 2 is sig, p=0.01, strat 4 borderline 0.07

map(1:4, function(x) {
  ndist = null_dist(df = RESULTS_ccm_wt_by_strat_surr %>% filter(stratum==x), s="scallop:jonah")
  prob = 1-ecdf(ndist)(max_rho_wt_by_strat[x,"max_S_J"])
  return(prob)
}) #none

map(1:4, function(x) {
  ndist = null_dist(df = RESULTS_ccm_wt_by_strat_surr %>% filter(stratum==x), s="rock:jonah")
  prob = 1-ecdf(ndist)(max_rho_wt_by_strat[x,"max_R_J"])
  return(prob)
}) #none

map(1:4, function(x) {
  ndist = null_dist(df = RESULTS_ccm_wt_by_strat_surr %>% filter(stratum==x), s="jonah:scallop")
  prob = 1-ecdf(ndist)(max_rho_wt_by_strat[x,"max_J_S"])
  return(prob)
}) #none

#none sig for jonah:scallop, scallop:jonah, or rock:jonah
```